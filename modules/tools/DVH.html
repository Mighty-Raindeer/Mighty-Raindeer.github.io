<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DVH Analysis Tool | Dose-Volume Histogram Analysis</title>
    <meta name="description" content="Interactive DVH analysis tool for radiation therapy planning. Analyze cumulative and differential dose-volume histograms with statistical metrics.">
    
    <style>
        :root {
            --bg-primary: #1a1a1a;
            --bg-secondary: #242424;
            --bg-card: #2d2d2d;
            --text-primary: #e0e0e0;
            --text-secondary: #b0b0b0;
            --accent-primary: #ff5722;
            --accent-hover: #f4511e;
            --border-color: rgba(255, 255, 255, 0.1);
        }

        body {
            margin: 0;
            padding: 20px;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            font-family: 'Montserrat', sans-serif;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            color: var(--accent-primary);
            text-align: center;
            margin-bottom: 30px;
        }

        .controls-panel {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            margin-bottom: 20px;
        }

        .control-row {
            display: flex;
            gap: 20px;
            align-items: center;
            margin-bottom: 15px;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .control-group label {
            font-size: 0.9rem;
            color: var(--text-primary);
        }

        .control-group select,
        .control-group input {
            padding: 6px 10px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 4px;
        }

        button {
            padding: 8px 16px;
            background: var(--accent-primary);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        button:hover {
            background: var(--accent-hover);
        }

        .visualization-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .chart-section {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .chart-section h2 {
            color: var(--accent-primary);
            margin-top: 0;
            font-size: 1.2rem;
        }

        .chart-container {
            width: 100%;
            height: 500px;
            background: var(--bg-card);
            border-radius: 4px;
            position: relative;
        }

        canvas {
            width: 100%;
            height: 100%;
        }

        .statistics-panel {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .statistics-panel h2 {
            color: var(--accent-primary);
            margin-top: 0;
            font-size: 1.2rem;
        }

        .structure-stats {
            padding: 15px;
            background: var(--bg-card);
            border-radius: 4px;
        }

        .structure-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .structure-name {
            font-weight: bold;
            color: var(--text-primary);
        }

        .structure-color {
            width: 20px;
            height: 20px;
            border-radius: 3px;
            border: 1px solid var(--border-color);
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .stat-value {
            color: var(--text-primary);
            font-weight: 500;
        }

        .constraint-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .constraint-table th,
        .constraint-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .constraint-table th {
            background: var(--bg-card);
            color: var(--accent-primary);
            font-size: 0.9rem;
        }

        .constraint-status {
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .constraint-pass {
            background: rgba(76, 175, 80, 0.2);
            color: #4caf50;
        }

        .constraint-warning {
            background: rgba(255, 152, 0, 0.2);
            color: #ff9800;
        }

        .constraint-fail {
            background: rgba(244, 67, 54, 0.2);
            color: #f44336;
        }

        .toggle-group {
            display: flex;
            gap: 10px;
        }

        .toggle-button {
            padding: 6px 12px;
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .toggle-button.active {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }

        .info-box {
            background: var(--bg-card);
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
            border-left: 3px solid var(--accent-primary);
        }

        .info-box h3 {
            margin-top: 0;
            color: var(--accent-primary);
        }

        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 10px;
            padding: 10px;
            background: var(--bg-card);
            border-radius: 4px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-color {
            width: 20px;
            height: 3px;
            border-radius: 2px;
        }

        .legend-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        @media (max-width: 768px) {
            .visualization-grid {
                grid-template-columns: 1fr;
            }
            
            .control-row {
                flex-direction: column;
                align-items: stretch;
            }
            
            .control-group {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Dose-Volume Histogram (DVH) Analysis Tool</h1>
        
        <div class="controls-panel">
            <div class="control-row">
                <div class="control-group">
                    <label>Y-Axis:</label>
                    <div class="toggle-group">
                        <button class="toggle-button active" onclick="setVolumeType('relative')">Relative (%)</button>
                        <button class="toggle-button" onclick="setVolumeType('absolute')">Absolute (cc)</button>
                    </div>
                </div>

                <button onclick="exportDVH()">Export Data</button>
            </div>
        </div>

        <div class="visualization-grid">
            <div class="chart-section">
                <h2>Cumulative DVH Curves</h2>
                <div class="chart-container">
                    <canvas id="dvh-canvas"></canvas>
                </div>
                <div class="legend" id="dvh-legend">
                    <!-- Legend items will be added dynamically -->
                </div>
            </div>
        </div>

        <div class="chart-section">
            <h2>Structure Statistics</h2>
            <div class="stats-grid" id="structure-stats-container">
                <!-- Statistics will be populated dynamically -->
            </div>
        </div>

        <div class="chart-section">
            <h2>Dose Constraints</h2>
            <table class="constraint-table">
                <thead>
                    <tr>
                        <th>Structure</th>
                        <th>Constraint</th>
                        <th>Goal</th>
                        <th>Actual</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="constraints-tbody">
                    <!-- Constraints will be populated dynamically -->
                </tbody>
            </table>
        </div>

        <div class="chart-section">
            <h2>Dose Statistics</h2>
            <div class="control-row">
                <div class="control-group">
                    <label>Structure:</label>
                    <select id="structure-select">
                        <option value="ptv">PTV</option>
                        <option value="rectum">Rectum</option>
                        <option value="bladder">Bladder</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Query Type:</label>
                    <select id="query-type">
                        <option value="d-at-v">Dose at Volume (Dx)</option>
                        <option value="v-at-d">Volume at Dose (Vx)</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Value:</label>
                    <input type="number" id="query-value" step="1" value="95">
                    <span id="query-unit">%</span>
                </div>
                <button onclick="queryDVH()">Calculate</button>
                <span id="query-result" style="margin-left: 20px; font-weight: bold;"></span>
            </div>
        </div>

        <div class="info-box">
            <h3>Understanding Cumulative DVH</h3>
            <p><strong>Cumulative DVH</strong> shows the <em>percentage of volume receiving AT LEAST a given dose</em>.</p>
            <ul>
                <li>The curve starts at 100% at dose = 0 (entire structure receives at least 0 Gy)</li>
                <li>The curve decreases monotonically as dose increases</li>
                <li>For targets: Ideally steep falloff near prescription dose (good coverage)</li>
                <li>For OARs: Ideally rapid falloff (most volume receives low dose)</li>
            </ul>

            <h3>DVH Analysis Metrics</h3>
            <p><strong>Common DVH Parameters:</strong></p>
            <ul>
                <li><strong>D95, D98:</strong> Minimum dose received by 95% or 98% of the volume (coverage metric)</li>
                <li><strong>D2, D0.03cc:</strong> Near-maximum dose (hot spot evaluation)</li>
                <li><strong>V20, V5:</strong> Volume (%) receiving at least 20 Gy or 5 Gy (low dose spread)</li>
                <li><strong>Mean Dose:</strong> Average dose to the structure (calculated as integral of DVH)</li>
                <li><strong>Conformity Index (CI):</strong> Ratio of prescription isodose volume to target volume</li>
                <li><strong>Homogeneity Index (HI):</strong> (D2 - D98) / D50 (lower is more homogeneous)</li>
            </ul>
        </div>
    </div>

    <script>
        class DVHAnalyzer {
            constructor() {
                this.canvas = document.getElementById('dvh-canvas');
                this.ctx = this.canvas.getContext('2d');
                this.dvhType = 'cumulative';
                this.volumeType = 'relative';
                this.structures = this.getStructures();
                
                this.setupCanvas();
                this.bindEvents();
                this.drawDVH();
                this.updateStatistics();
                this.updateConstraints();
            }

            setupCanvas() {
                const rect = this.canvas.parentElement.getBoundingClientRect();
                this.canvas.width = rect.width;
                this.canvas.height = rect.height;
            }

            bindEvents() {
                window.addEventListener('resize', () => {
                    this.setupCanvas();
                    this.drawDVH();
                });
            }

            getStructures() {
                return [
                    { name: 'PTV', color: '#ff5722', type: 'target', volume: 125.3 },
                    { name: 'Rectum', color: '#2196f3', type: 'oar', volume: 85.2 },
                    { name: 'Bladder', color: '#4caf50', type: 'oar', volume: 250.5 },
                    { name: 'Femoral Heads', color: '#ff9800', type: 'oar', volume: 120.8 }
                ];
            }

            generateDVHData(structure) {
                const points = [];
                const maxDose = structure.type === 'target' ? 85 : 70;

                if (this.dvhType === 'cumulative') {
                    // Generate CUMULATIVE DVH: % of volume receiving AT LEAST this dose
                    // For cumulative DVH, curve should start at 100% at dose=0 and decrease
                    for (let dose = 0; dose <= maxDose; dose += 0.5) {
                        let volume;
                        if (structure.type === 'target') {
                            // Target: steep falloff near prescription dose
                            // Represents good target coverage with dose concentrated around Rx
                            const prescriptionDose = 78; // Gy
                            const d50 = prescriptionDose - 3; // 50% volume point
                            const gamma = 3; // Steepness (higher = steeper)

                            // Inverted sigmoid: starts at 100%, falls steeply near prescription
                            volume = 100 - (100 / (1 + Math.exp(-gamma * (dose - d50) / 5)));
                        } else {
                            // OAR: exponential falloff from 100%
                            // Most OAR volume receives low dose, small volume receives high dose
                            const lambda = structure.name.includes('Rectum') ? 0.06 :
                                          structure.name.includes('Bladder') ? 0.05 :
                                          structure.name.includes('Lung') ? 0.08 :
                                          structure.name.includes('Heart') ? 0.10 :
                                          structure.name.includes('Parotid') ? 0.12 :
                                          structure.name.includes('Cord') ? 0.15 : 0.08;
                            volume = 100 * Math.exp(-lambda * dose);
                        }

                        // Ensure volume never goes below 0 or above 100%
                        volume = Math.max(0, Math.min(100, volume));

                        if (this.volumeType === 'absolute') {
                            volume = (volume / 100) * structure.volume;
                        }

                        points.push({ dose, volume });
                    }
                } else {
                    // Generate differential DVH (rarely used clinically)
                    // This is the derivative of the cumulative DVH
                    for (let dose = 0; dose <= maxDose; dose += 0.5) {
                        let volume;
                        if (structure.type === 'target') {
                            // Target: gaussian-like peak around prescription
                            const mean = 78;
                            const sigma = 3;
                            volume = 100 * Math.exp(-Math.pow(dose - mean, 2) / (2 * sigma * sigma));
                        } else {
                            // OAR: exponential with peak at low dose
                            const peak = 5;
                            volume = 100 * Math.exp(-Math.pow(dose - peak, 2) / 200);
                        }

                        if (this.volumeType === 'absolute') {
                            volume = (volume / 100) * structure.volume * 0.05; // Scale for differential
                        }

                        points.push({ dose, volume });
                    }
                }

                return points;
            }

            drawDVH() {
                const ctx = this.ctx;
                const width = this.canvas.width;
                const height = this.canvas.height;
                const padding = 60;
                
                // Clear canvas
                ctx.fillStyle = '#1a1a1a';
                ctx.fillRect(0, 0, width, height);
                
                // Draw axes
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(padding, padding);
                ctx.lineTo(padding, height - padding);
                ctx.lineTo(width - padding, height - padding);
                ctx.stroke();
                
                // Draw grid lines
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
                for (let i = 0; i <= 10; i++) {
                    const y = padding + (height - 2 * padding) * i / 10;
                    ctx.beginPath();
                    ctx.moveTo(padding, y);
                    ctx.lineTo(width - padding, y);
                    ctx.stroke();
                    
                    const x = padding + (width - 2 * padding) * i / 10;
                    ctx.beginPath();
                    ctx.moveTo(x, padding);
                    ctx.lineTo(x, height - padding);
                    ctx.stroke();
                }
                
                // Calculate max volume for y-axis scaling
                let maxVolume = 100; // Default for relative (%)
                if (this.volumeType === 'absolute') {
                    maxVolume = Math.max(...this.structures.map(s => s.volume));
                    // Round up to nearest 50 for cleaner axis
                    maxVolume = Math.ceil(maxVolume / 50) * 50;
                }

                // Draw DVH curves
                this.structures.forEach(structure => {
                    const data = this.generateDVHData(structure);

                    ctx.strokeStyle = structure.color;
                    ctx.lineWidth = 2;
                    ctx.beginPath();

                    data.forEach((point, index) => {
                        const x = padding + (width - 2 * padding) * (point.dose / 85);
                        const y = height - padding - (height - 2 * padding) * (point.volume / maxVolume);

                        if (index === 0) {
                            ctx.moveTo(x, y);
                        } else {
                            ctx.lineTo(x, y);
                        }
                    });

                    ctx.stroke();
                });
                
                // Draw axes labels
                ctx.fillStyle = 'white';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                
                // X-axis labels
                for (let i = 0; i <= 10; i++) {
                    const dose = (85 * i / 10).toFixed(0);
                    const x = padding + (width - 2 * padding) * i / 10;
                    ctx.fillText(dose, x, height - padding + 20);
                }
                ctx.fillText('Dose (Gy)', width / 2, height - 10);
                
                // Y-axis labels
                ctx.textAlign = 'right';
                for (let i = 0; i <= 10; i++) {
                    const volume = (maxVolume - (maxVolume * i / 10)).toFixed(0);
                    const y = padding + (height - 2 * padding) * i / 10;
                    ctx.fillText(volume, padding - 10, y + 5);
                }
                
                // Y-axis title
                ctx.save();
                ctx.translate(15, height / 2);
                ctx.rotate(-Math.PI / 2);
                ctx.textAlign = 'center';
                ctx.fillText(this.volumeType === 'relative' ? 'Volume (%)' : 'Volume (cc)', 0, 0);
                ctx.restore();
                
                this.updateLegend();
            }

            updateLegend() {
                const legendDiv = document.getElementById('dvh-legend');
                legendDiv.innerHTML = '';
                
                this.structures.forEach(structure => {
                    const item = document.createElement('div');
                    item.className = 'legend-item';
                    item.innerHTML = `
                        <div class="legend-color" style="background: ${structure.color}"></div>
                        <span class="legend-label">${structure.name}</span>
                    `;
                    legendDiv.appendChild(item);
                });
            }

            updateStatistics() {
                const container = document.getElementById('structure-stats-container');
                container.innerHTML = '';
                
                this.structures.forEach(structure => {
                    const stats = this.calculateStructureStats(structure);
                    
                    const statsDiv = document.createElement('div');
                    statsDiv.className = 'structure-stats';
                    statsDiv.innerHTML = `
                        <div class="structure-header">
                            <span class="structure-name">${structure.name}</span>
                            <div class="structure-color" style="background: ${structure.color}"></div>
                        </div>
                        <div class="stat-row">
                            <span>Volume:</span>
                            <span class="stat-value">${structure.volume.toFixed(1)} cc</span>
                        </div>
                        <div class="stat-row">
                            <span>Mean Dose:</span>
                            <span class="stat-value">${stats.meanDose.toFixed(1)} Gy</span>
                        </div>
                        <div class="stat-row">
                            <span>Max Dose (D0.03cc):</span>
                            <span class="stat-value">${stats.maxDose.toFixed(1)} Gy</span>
                        </div>
                        <div class="stat-row">
                            <span>D2:</span>
                            <span class="stat-value">${stats.d2.toFixed(1)} Gy</span>
                        </div>
                        <div class="stat-row">
                            <span>D95:</span>
                            <span class="stat-value">${stats.d95.toFixed(1)} Gy</span>
                        </div>
                        <div class="stat-row">
                            <span>D98:</span>
                            <span class="stat-value">${stats.d98.toFixed(1)} Gy</span>
                        </div>
                        <div class="stat-row">
                            <span>V20:</span>
                            <span class="stat-value">${stats.v20.toFixed(1)}%</span>
                        </div>
                    `;
                    container.appendChild(statsDiv);
                });
            }

            calculateStructureStats(structure) {
                const dvhData = this.generateDVHData(structure);

                // Calculate mean dose from cumulative DVH
                // Mean dose = integral of DVH curve / 100
                let meanDose = 0;
                for (let i = 1; i < dvhData.length; i++) {
                    const dDose = dvhData[i].dose - dvhData[i - 1].dose;
                    const avgVolume = (dvhData[i].volume + dvhData[i - 1].volume) / 2;
                    meanDose += dDose * avgVolume;
                }
                meanDose /= 100; // Normalize by 100%

                // Max dose: highest dose where volume > 0
                let maxDose = 0;
                for (let i = dvhData.length - 1; i >= 0; i--) {
                    if (dvhData[i].volume > 0.1) { // Allow for small numerical errors
                        maxDose = dvhData[i].dose;
                        break;
                    }
                }

                // D95: dose covering 95% of volume
                const d95 = this.getDoseAtVolume(dvhData, 95);

                // D98: dose covering 98% of volume
                const d98 = this.getDoseAtVolume(dvhData, 98);

                // D2: dose covering 2% of volume (near-max)
                const d2 = this.getDoseAtVolume(dvhData, 2);

                // V20: % volume receiving at least 20 Gy
                const v20 = this.getVolumeAtDose(dvhData, 20);

                return {
                    meanDose,
                    maxDose,
                    d95,
                    d98,
                    d2,
                    v20
                };
            }

            // Get dose at a specific volume percentage (for Dx queries)
            getDoseAtVolume(dvhData, volumePercent) {
                // Find the dose where exactly volumePercent of volume receives at least that dose
                for (let i = 0; i < dvhData.length - 1; i++) {
                    if (dvhData[i].volume >= volumePercent && dvhData[i + 1].volume < volumePercent) {
                        // Linear interpolation
                        const t = (volumePercent - dvhData[i + 1].volume) / (dvhData[i].volume - dvhData[i + 1].volume);
                        return dvhData[i + 1].dose + t * (dvhData[i].dose - dvhData[i + 1].dose);
                    }
                }
                // If volume percent is 100%, return minimum dose
                if (volumePercent >= dvhData[0].volume) return dvhData[0].dose;
                // If not found, return 0
                return 0;
            }

            // Get volume percentage at a specific dose (for Vx queries)
            getVolumeAtDose(dvhData, dose) {
                // Find the % volume receiving at least this dose
                for (let i = 0; i < dvhData.length - 1; i++) {
                    if (dvhData[i].dose <= dose && dvhData[i + 1].dose > dose) {
                        // Linear interpolation
                        const t = (dose - dvhData[i].dose) / (dvhData[i + 1].dose - dvhData[i].dose);
                        return dvhData[i].volume + t * (dvhData[i + 1].volume - dvhData[i].volume);
                    }
                }
                // If dose is beyond max, return 0
                if (dose > dvhData[dvhData.length - 1].dose) return 0;
                // If dose is below min, return 100
                if (dose < dvhData[0].dose) return dvhData[0].volume;
                return 0;
            }

            updateConstraints() {
                const tbody = document.getElementById('constraints-tbody');
                tbody.innerHTML = '';
                
                const constraints = this.getConstraints();
                constraints.forEach(constraint => {
                    const row = document.createElement('tr');
                    const status = this.evaluateConstraint(constraint);
                    
                    row.innerHTML = `
                        <td>${constraint.structure}</td>
                        <td>${constraint.metric}</td>
                        <td>${constraint.goal}</td>
                        <td>${constraint.actual}</td>
                        <td><span class="constraint-status ${status}">${status.replace('constraint-', '').toUpperCase()}</span></td>
                    `;
                    tbody.appendChild(row);
                });
            }

            getConstraints() {
                const constraints = [];

                // Generate constraints based on current plan with actual calculated values
                this.structures.forEach(structure => {
                    const dvhData = this.generateDVHData(structure);
                    const stats = this.calculateStructureStats(structure);

                    if (structure.type === 'target') {
                        // Target constraints
                        constraints.push({
                            structure: structure.name,
                            metric: 'D95',
                            goal: '≥ 76 Gy',
                            actual: `${stats.d95.toFixed(1)} Gy`,
                            goalValue: 76,
                            operator: '≥'
                        });
                        constraints.push({
                            structure: structure.name,
                            metric: 'D2',
                            goal: '≤ 83 Gy',
                            actual: `${stats.d2.toFixed(1)} Gy`,
                            goalValue: 83,
                            operator: '≤'
                        });
                    } else {
                        // OAR constraints
                        if (structure.name.includes('Rectum')) {
                            const v70 = this.getVolumeAtDose(dvhData, 70);
                            const v50 = this.getVolumeAtDose(dvhData, 50);
                            constraints.push({
                                structure: structure.name,
                                metric: 'V70',
                                goal: '< 20%',
                                actual: `${v70.toFixed(1)}%`,
                                goalValue: 20,
                                operator: '<'
                            });
                            constraints.push({
                                structure: structure.name,
                                metric: 'V50',
                                goal: '< 50%',
                                actual: `${v50.toFixed(1)}%`,
                                goalValue: 50,
                                operator: '<'
                            });
                        } else if (structure.name.includes('Bladder')) {
                            const v70 = this.getVolumeAtDose(dvhData, 70);
                            constraints.push({
                                structure: structure.name,
                                metric: 'V70',
                                goal: '< 35%',
                                actual: `${v70.toFixed(1)}%`,
                                goalValue: 35,
                                operator: '<'
                            });
                        } else if (structure.name.includes('Femoral')) {
                            const d5 = this.getDoseAtVolume(dvhData, 5);
                            constraints.push({
                                structure: structure.name,
                                metric: 'D5',
                                goal: '< 50 Gy',
                                actual: `${d5.toFixed(1)} Gy`,
                                goalValue: 50,
                                operator: '<'
                            });
                        } else if (structure.name.includes('Lung')) {
                            const v20 = this.getVolumeAtDose(dvhData, 20);
                            const v5 = this.getVolumeAtDose(dvhData, 5);
                            constraints.push({
                                structure: structure.name,
                                metric: 'V20',
                                goal: '< 30%',
                                actual: `${v20.toFixed(1)}%`,
                                goalValue: 30,
                                operator: '<'
                            });
                            constraints.push({
                                structure: structure.name,
                                metric: 'V5',
                                goal: '< 60%',
                                actual: `${v5.toFixed(1)}%`,
                                goalValue: 60,
                                operator: '<'
                            });
                        } else if (structure.name.includes('Heart')) {
                            constraints.push({
                                structure: structure.name,
                                metric: 'Mean',
                                goal: '< 10 Gy',
                                actual: `${stats.meanDose.toFixed(1)} Gy`,
                                goalValue: 10,
                                operator: '<'
                            });
                        } else if (structure.name.includes('Parotid')) {
                            constraints.push({
                                structure: structure.name,
                                metric: 'Mean',
                                goal: '< 26 Gy',
                                actual: `${stats.meanDose.toFixed(1)} Gy`,
                                goalValue: 26,
                                operator: '<'
                            });
                        } else if (structure.name.includes('Cord')) {
                            constraints.push({
                                structure: structure.name,
                                metric: 'Max',
                                goal: '< 45 Gy',
                                actual: `${stats.maxDose.toFixed(1)} Gy`,
                                goalValue: 45,
                                operator: '<'
                            });
                        }
                    }
                });

                return constraints;
            }

            evaluateConstraint(constraint) {
                const actual = parseFloat(constraint.actual);
                const goalValue = constraint.goalValue;
                const operator = constraint.operator;

                let passed = false;
                let marginPercent = 0;

                switch (operator) {
                    case '<':
                        passed = actual < goalValue;
                        marginPercent = ((goalValue - actual) / goalValue) * 100;
                        break;
                    case '≤':
                        passed = actual <= goalValue;
                        marginPercent = ((goalValue - actual) / goalValue) * 100;
                        break;
                    case '>':
                        passed = actual > goalValue;
                        marginPercent = ((actual - goalValue) / goalValue) * 100;
                        break;
                    case '≥':
                        passed = actual >= goalValue;
                        marginPercent = ((actual - goalValue) / goalValue) * 100;
                        break;
                }

                if (passed) return 'constraint-pass';
                // Warning if within 5% of goal
                if (Math.abs(marginPercent) < 5) return 'constraint-warning';
                return 'constraint-fail';
            }
        }

        // Global functions for button controls
        function setVolumeType(type) {
            document.querySelectorAll('.toggle-button').forEach(btn => {
                if (btn.textContent.toLowerCase().includes(type)) {
                    btn.classList.add('active');
                } else if (btn.textContent.includes('Relative') || btn.textContent.includes('Absolute')) {
                    btn.classList.remove('active');
                }
            });
            
            if (window.dvhAnalyzer) {
                window.dvhAnalyzer.volumeType = type;
                window.dvhAnalyzer.drawDVH();
            }
        }

        function queryDVH() {
            const structureName = document.getElementById('structure-select').value;
            const queryType = document.getElementById('query-type').value;
            const value = parseFloat(document.getElementById('query-value').value);

            if (!window.dvhAnalyzer) return;

            // Find the structure
            const structure = window.dvhAnalyzer.structures.find(s =>
                s.name.toLowerCase().includes(structureName.toLowerCase())
            );

            if (!structure) {
                document.getElementById('query-result').textContent = 'Structure not found';
                return;
            }

            const dvhData = window.dvhAnalyzer.generateDVHData(structure);
            let result;

            if (queryType === 'd-at-v') {
                // Dx: dose at volume percentage
                const dose = window.dvhAnalyzer.getDoseAtVolume(dvhData, value);
                result = `D${value} = ${dose.toFixed(1)} Gy`;
            } else {
                // Vx: volume at dose
                const volume = window.dvhAnalyzer.getVolumeAtDose(dvhData, value);
                result = `V${value} = ${volume.toFixed(1)}%`;
            }

            document.getElementById('query-result').textContent = result;
        }

        function exportDVH() {
            // Generate CSV export
            if (!window.dvhAnalyzer) return;

            let csv = 'Structure,Dose (Gy),Volume (%)\n';
            window.dvhAnalyzer.structures.forEach(structure => {
                const dvhData = window.dvhAnalyzer.generateDVHData(structure);
                dvhData.forEach(point => {
                    // Convert to percentage if in absolute mode
                    const volumePercent = window.dvhAnalyzer.volumeType === 'absolute'
                        ? (point.volume / structure.volume) * 100
                        : point.volume;
                    csv += `${structure.name},${point.dose.toFixed(1)},${volumePercent.toFixed(2)}\n`;
                });
            });

            // Download CSV
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'dvh_data.csv';
            a.click();
            URL.revokeObjectURL(url);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            window.dvhAnalyzer = new DVHAnalyzer();
        });
    </script>
</body>
</html>